import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import './CodexReader.css';

/**
 * 코덱스 리더
 * - 좌/우 버튼, 키보드(←/→), 스와이프(터치)로 페이지 넘김
 * - 하단 챕터바(빠른 이동)
 * - 챕터(층) 내 섹션(장소) → 각 섹션의 페이지(문단/지침)
 * - 쿼리 파라미터로 진입: ?ch=0&sec=0&page=0 (없으면 0)
 */

export default function CodexReader() {
    const nav = useNavigate();
    const { search } = useLocation();
    const params = new URLSearchParams(search);
    const initialCh = Math.max(0, parseInt(params.get('ch') ?? '0', 10));
    const initialSec = Math.max(0, parseInt(params.get('sec') ?? '0', 10));
    const initialPage = Math.max(0, parseInt(params.get('page') ?? '0', 10));

    // 데이터
    const chapters = useMemo(() => ([
        {
            title: '一 ｜ B1',
            sections: [
                {
                    name: '로비',
                    pages: [
                        '복도 끝에서부터 일정한 간격의 발소리가 난다. 멈추면 같이 멈춘다.',
                        '접수대 표면엔 긁힌 흔적: “올라가지 마…” — 글씨는 계속 얕아진다.',
                        '엘리베이터 거울 속 네 모습과 너는 몇 프레임 어긋나 있다.',
                    ],
                },
                {
                    name: '백스테이지',
                    pages: [
                        '조명이 꺼져 있을 때만 보이는 경로 표시가 있다. 불을 끄면 문이 가까워진다.',
                        '도면상 창고는 2칸인데 실제론 3칸이다. 세 번째 칸은 다시 닫아두어라.',
                    ],
                },
                {
                    name: '라이브 스테이지',
                    pages: [
                        '관객석은 비어 있으나 무대 위 마이크가 호흡을 센다. “하나, 둘…”',
                        '무대 오르막의 발판 다섯째는 없는 것처럼 밟혀야 한다.',
                    ],
                },
            ],
        },
        {
            title: '二 ｜ 1F',
            sections: [
                {
                    name: '로비',
                    pages: [
                        '안내 데스크 위 명패의 이름은 네가 생각한 것과 다르다. 그 이름을 말하지 말 것.',
                        '입구 CCTV는 들어오는 사람만 기록한다. 나가는 장면은 없다.',
                    ],
                },
                {
                    name: '카페 시나몬',
                    pages: [
                        '메뉴판 마지막 줄이 깜빡인다. 보이는 대로 주문하지 말고, 네가 본 대로 주문하라.',
                        '컵 가장자리에 남은 흔적이 두 겹이면 너는 혼자가 아니다.',
                    ],
                },
            ],
        },
        {
            title: '三 ｜ 5F',
            sections: [
                {
                    name: '배움터',
                    pages: [
                        '칠판에는 아무것도 적히지 않았지만, 지워지는 소리가 난다.',
                        '뒤에서 누가 대답하면 질문을 바꿔라. 정답은 네가 정한다.',
                    ],
                },
                {
                    name: '대도구실',
                    pages: [
                        '문짝은 하나인데 경첩은 둘이다. 하나는 너를 위해 존재하지 않는다.',
                    ],
                },
            ],
        },
        {
            title: '四 ｜ 6F',
            sections: [
                { name: '의상룸', pages: ['옷걸이가 귓속말을 한다. “네가 고른 건 아니야.”'] },
            ],
        },
        {
            title: '五 ｜ 7F',
            sections: [
                { name: 'NEW DIMENSION', pages: ['창 없는 방에서만 빛이 새어 나온다.'] },
                { name: '의무실', pages: ['대기번호는 항상 네 앞이다. 그러나 불리면 뒤를 본다.'] },
            ],
        },
        {
            title: '六 ｜ 8F',
            sections: [
                { name: '녹화부스', pages: ['마이크 테스트 음성이 다시 녹음 위로 올라탄다.'] },
                { name: '보컬룸', pages: ['고음에서 유리가 웃는다. 네가 먼저 내려와라.'] },
                { name: '샤워룸', pages: ['서리 위 글자는 “여기”가 아니라 “거기”.'] },
                { name: '연주스튜디오', pages: ['박자가 맞아떨어지면 누군가 한 명은 사라진다.'] },
                { name: '간이스튜디오', pages: ['3분 이상 녹음된 것은 되감을 수 없다.'] },
            ],
        },
        {
            title: '七 ｜ 9F',
            sections: [{ name: '댄스룸 밀집구역', pages: ['거울 속 카운트가 한 박자 빠르다. 맞추지 마라.'] }],
        },
        {
            title: '八 ｜ 10F',
            sections: [
                { name: '미팅룸', pages: ['의자 개수는 사람 수보다 하나 많다. 남는 자리에 앉지 마라.'] },
                { name: '사원식당', pages: ['수저통은 너의 위치를 세고 있다. 짝이 맞으면 식사를 멈춰라.'] },
            ],
        },
        {
            title: '九 ｜ 12F',
            sections: [
                { name: 'RHYTHM LINK', pages: ['동시에 다른 층에서 음악이 들리면, 그건 같은 곡이 아니다.'] },
                { name: '공중정원', pages: ['발밑의 흙이 맥박을 가진다. 박자를 세지 마라.'] },
            ],
        },
        {
            title: '十 ｜ 15F',
            sections: [
                { name: '트레이닝룸', pages: ['러닝머신 속도는 네 심박과 협상한다. 네가 진다.'] },
                { name: '스탠드 앞', pages: ['불빛 아래 그림자가 버티면, 불을 끄고 기다려라.'] },
            ],
        },
        {
            title: '十一 ｜ 18F',
            sections: [{ name: 'COSMIC PRODUCTION', pages: ['빈 데스크에만 계약서가 놓인다. 빈 곳에 사인하지 마라.'] }],
        },
        {
            title: '十二 ｜ 19F',
            sections: [{ name: '레스팅룸', pages:  [
`잠이 먼저 오면 네가 아닌 것이 깨어난다.\n
현재 귀하께서 계신 레스팅룸은 연구 결과, 단순히 휴게용으로 이용할 경우 뚜렷한 위협 요소가 없는 것으로 확인되었습니다. 단, 해당 공간은 조사가 이루어지지 않았으므로 차후 위협이 될 요소가 발생할 수 있음에 유의 바라며, 해당 상황 발생 시 지침서를 업데이트해주시기 바랍니다.\n

1. 본 공간에 매일 생성되는 랜덤한 디저트를 통해 체력 회복 또는 개인의 능력의 상승을 유도할 수 있음을 확인하였습니다. 단, 아직 모든 디저트가 연구되지는 않았으며, 일부 디저트의 경우 영구적으로 지속되는 부작용이 있을 수 있으므로 사전에 주의 바랍니다.\n
1.1. 단, 해당 공간에서 얻을 수 있는 가장 이로운 효과는 『딸기 수플레 케이크』로 확인됩니다.\n
1-2. 발견할 수 있는 음식은 다음과 같습니다.\n
딸기 수플레 케이크 : 체력 완전 회복 후 -1\n
허니 시나몬 쿠키 : 행운+1\n
카라멜 퐁당 쇼콜라 : 관찰 -1\n
복숭아 타르트 : 체력 +3\n
크림치즈 마카롱 : 민첩 -1\n
체리 젤라또 : 행운 -1\n
망고 푸딩 : 정신력 -1\n

2. 레스팅룸은 기본 금연 및 금주입니다.\n
해당 공간에는 특별히 지켜야 할 규정이 없다고 말씀드렸으나, 이는 『일반적인 레스팅룸의 에티켓』을 준수하였을 때의 상황입니다.\n
실제로 이곳은 감시받지 않으며, 감시 장치도 존재하지 않지만 이 공간에 오래 머무른 이들은 공통적으로 이 공간이 자신의 ‘용도’와 ‘기분’을 관찰한다고 진술하였습니다.\n
귀하께서 이곳을 단순한 대화 및 휴식 공간으로 이용하고 있다면 높은 확률로 그것은 무해합니다. 그러나 그것이 이 공간을 실험실, 병실 혹은 그 외의 무엇으로 오해하기 시작할 경우, 당신의 말투와 움직임, 심지어는 마음속의 용도를 기준으로 하여 공간 자체가 구조적으로 반응할 수 있습니다.\n
2-1. 현재까지 보고된 이상 징후로는 다음과 같습니다:\n
- 햇빛과 달빛이 동시에 비추기 시작함\n
- 먹던 컵이 사라지고 대신 잔여물만 남아 있음\n
- 같은 방에 있는 사람들에게 말소리가 들리지 않음. (차후 확인 결과, 말소리가 외부로 중계된 것으로 파악됨.)\n
- 방 안에 있던 사람들 전원이 동시에 같은 사람을 상상함\n
- 수면 중 일정 비율의 체온이 반납되지 않음\n
정확한 원인은 밝혀지지 않았으며, 그에 따라 여러분 모두가 『그저 레스팅룸에서 휴식할 뿐이라는 태도』를 유지하실 것을 권장합니다.\n
이외의 목적을 부여할 경우 그 대가는 예기치 못한 방향으로 현실화될 수 있습니다.\n
만에 하나 출입구가 사라질 경우 돌이킬 수 없으므로, 저희는 귀하뿐만 아니라 귀중한 회복의 용도로 쓰일 공간을 잃지 않길 바랍니다.\n
2-2. 해당 공간에 순수한 물을 제외한 외부 음식을 반입하지 마십시오.\n
귀하께서 외부 음식을 소지하거나 반입할 경우, 이미 해당 공간 내에 있던 모든 인원은 갑작스럽고 제어 불가능한 식욕을 경험하게 됩니다.\n
귀하께서는 이미 해당 공간으로의 생존을 통해 『굶어도 특별히 식욕을 느끼지 않는다』는 사실을 깨달으셨을 것으로 판단됩니다.\n
그러나 본 항목에서 표현하는 식욕은 일반적인 배고픔과 다르며, 단순한 허기가 아닌, 미각의 심연을 찌르는 듯한 지속적 갈망이 치밀어 대부분의 사람이 저항하지 못합니다. 이는 음식을 반드시 먼저 먹어야만 한다는 강박으로 나타납니다.\n

이후의 행동은 상황에 따라 알맞는 대응 방법을 골라 수행하시면 됩니다.\n
2-1-1. 외부 음식의 섭취와 동시에 식욕이 갈무리되었을 경우, 귀하께서는 무사히 제정신을 찾으셨습니다. 명심하시면 됩니다.\n
2-1-2. 외부 음식을 섭취하였음에도 식욕이 해소되지 않았을 경우, 유감입니다. 현재 귀하의 진정한 문제는 식욕이 『외부 음식의 섭취』로 마무리되지 않았다는 점에 있습니다.\n
외부 음식이 모두 소비된 이후에도 식욕이 잔존할 경우, 귀하의 본능은 자연스럽게 눈앞의 휴게실 디저트를 향하게 되실 겁니다. 해당 시점에 이미 디저트를 모두 섭취한 상태라면 식욕은 끝없이 샘솟아 무엇이든 먹고 싶다는 환각으로 이어질 수 있습니다.\n
해당 상태는 종류를 불문하고 응접실의 디저트를 1개 이상 완전히 섭취할 때까지 지속됩니다.\n
만일 누군가가 해당 상태로 확인되며, 해당 인원이 귀하보다 물리적으로 강하고 당장 먹일 디저트가 없는 경우, 귀하께서 산 채로 먹힐 위기에 당도하기 전에 차라리 다수의 동료들과 함께 제압하시는 편을 추천 드립니다.\n
2-1-3. 2-1-2의 조항에 나타난 『식욕』은 생명체나 생명체로 착각할 수 있는 거의 모든 대상에게 발생함을 확인하였습니다.\n
동료를 뜯어먹는 것보다는 마네킹을 뜯어먹게 하는 것이 낫다고 판단할 수 있으나, 회계직원 U의 사례에 근거하여 마네킹을 취식하는 행위는 권장하지 않으므로 유의하여 주십시오.\n
귀하께서 신체 일부를 회복할 능력을 가지고 있다면 차라리 동료를 위해 신체를 내어주는 쪽이 나을 수 있습니다.\n
\n
U씨는 회계부 소속 직원으로, 정기 결산 마감 전날 장시간 야근 중 레스팅룸에서 휴게하였음. 이때 인스턴트 간편식을 들고 등장한 타 부서 직원 S군을 목격한 직후 강한 허기를 호소. 당시 레스팅룸의 디저트는 이미 전부 소진된 상태였음. U씨는 S군의 간편식을 빼앗아 섭취한 직후 S군을 기습함. 이에 S군이 방어하여 기습이 실패하자 비치된 마네킹의 손목 부위를 뜯어내어 섭취하는 행위를 함.\n
귀환 직후, 하악 및 설근 부위에 세라믹성 질감과 유사한 조직 변형이 관찰됨. 해당 부위는 피부색을 유지하나 표면에 얇은 광택층이 덮여 있어, 마네킹 표면 코팅과 유사한 반사율을 보임. 구강 내 일부 치아는 자발적으로 분리되어 사라졌으며, 치아가 있던 자리는 동일 형상의『마네킹 관절 부품』재질로 변형됨.\n
이후 약 48시간 동안 U씨는 음식이나 음료를 씹는 대신 고정된 턱 각도와 간격을 반복하며, 그 패턴은 치악에 관여하는 관절이 인위적으로 가동되는 것처럼 보였음. 이상함을 느낀 동료 직원들이 강제로 입을 열어본 결과 혀와 점막에서 미약한 플라스틱 소각 냄새가 지속적으로 감지됨. U씨는 5일간 주위 인물의 팔이나 손목을 시선으로 따라가는 습관이 생겼으며, ‘달콤하다’라는 단어를 반복 발화함. 해당 발화 시 특유의 비대칭 곡선으로 휘어 웃는 모습 관찰됨.\n

3. 디저트를 반출하지 마십시오\n
응접실 디저트는 해당 공간에서만 유효한 식재입니다.\n
이를 휴대하거나 외부로 반출할 경우, 다음과 같은 현상이 보고되었습니다:\n
- 디저트가 상하거나 증발하여 실체를 잃음\n
- 일정 시간 후, 몸속에서 디저트 냄새가 진동함\n
- 향과 맛이 피부를 통해 배출되며, 인근의 식욕을 자극함\n
- 꿈에서 같은 디저트가 나타나 섭취를 강요하는 장면이 반복됨\n
특히 같은 디저트를 두 번 이상 반출 시도할 경우, 더 이상 응접실에 해당 디저트가 생기지 않을 수 있습니다.\n
3-1. 해당 조항을 역이용하여 일부러 손해가 되는 디저트를 반출하실 분께서 계실 것으로 판단됩니다. 이렇게 될 경우 어떤 일이 발생하는지 확싫히 파악되지 않았으므로 주의해 주십시오.\n

4. 레스팅룸의 ‘기분’에 따라 구조가 변할 수 있습니다.\n
4-1. 보고된 이상 징후는 항목 2를 참고해 주세요.\n
4-2. 특히, 마네킹의 수가 늘어나거나 위치가 바뀌는 경우, 혹은 마네킹이 귀하를 비웃는 소리가 들린 경우 즉시 레스팅룸의 모든 시설을 두고 퇴실하실 것을 권고드립니다. 이는 레스팅룸이 귀하의 체류를 환영하지 않는다는 명확한 신호입니다. 위반하여 화를 입을 상황을 자처하지 마십시오.\n

5. 낮은 확률로 마네킹과 대화가 가능합니다.\n
5-1. 마네킹의 수가 방 안에 있는 인원 수보다 적을 경우, 마네킹 앞에서 3초간 눈을 마주친친 후 예의를 갖추어 마네킹과 대화를 시도하십시오. 귀하께서 충분한 운을 소지하고 계신다면 마네킹은 기꺼이 응할 것입니다.\n
5-2. 해당 과정에서 마네킹의 관절이 기괴하게 꺾이는 등의 사유로 대화를 진행하고 싶지 않는 상황이 발생할 수 있습니다. 이는 자연스러운 상황이나, 마네킹의 앞에서 표정이나 말투 등으로 귀하의 감정을 들키지 않도록 각별히 주의해 주십시오. 대화의 성공률은 귀하의 자연스러운 태도와 연관됩니다.\n
5-3. 마네킹은 높은 확률로 당신과의 대화를 거부할 수 있습니다. 대화 기회는 총 3회까지 주어집니다. 3번의 기회를 모두 소진한 이후 무리하여 대화를 시도하지 마십시오. 그것이 귀하의 존재를 고깝게 여기는 순간 귀하께서는 귀중한 체력 회복의 기회를 놓치게 됩니다.\n
5-4. 낮은 확률로 대화 기회가 남았음에도 불구하고 대화 시도 직후 마네킹 3구가 동시에 당신을 돌아볼 수 있습니다. 이 경우, 모든 대화 시도를 포기하고 레스팅룸을 떠나십시오.\n

6. 드물게 수면 중 마네킹이 본인들을 쳐다보는 것을 보았다고 주장하는 경우가 있습니다.\n
6-1. 해당 행위가 특별히 위협이 되지는 않는 것으로 사료되나, 어떤 경우라도 귀하의 육감을 맹신하십시오.\n

7. 익숙한 얼굴?`
            ] }],
        },
        {
            title: '十三 ｜ 20F',
            sections: [
                {
                    name: 'STARMAKER PRODUCTION',
                    pages: [
                        `스타메이커 프로덕션, 이하 스타프로에서는 유독 지침서의 훼손이 자주 이루어지는 것으로 판단됩니다. 하지만 그것들이 이미 작성된 글자를 수정하거나 편집하지는 못하는 것으로 판단된 바, 모든 조항의 마무리에 『당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.』를 작성해 두었습니다. 여러분의 시간은 금입니다. 출처가 불분명한 조항에 여러분의 시간을 낭비하지 마십시오.

유감스럽게도 현재 귀하께서 계신 스타프로 사무소는 다른 공간에 비해 알려진 정보가 극히 적어 여러분의 생환을 기대하기 어렵습니다. 또한 일부 인원은 출입 의사를 두는 것이 아닌, 그저 출입문에 접촉하는 것만으로도 출입으로 인식되어 내부에서 깨어나는 것으로 판단되었습니다. 이에 원인불명의 사태가 해결될 때까지 해당 공간의 접근 자체를 권장하지 않고 있습니다. 모종의 사유로 일단 입장하신 경우 당신이 만반의 준비 하에 입장하신 것이기를 빕니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

자신의 아이돌이 논란 없이 완벽한 모습만을 보이길 바라는 것은 모든 아이돌 팬의 공통 사항입니다. 임직원의 실수 또한 아이돌의 관리 태만으로 이루어질 수 있으므로 지양됩니다. 해당 문서를 열람하는 당신이 아이돌이든 직원이든, 혹은 제 3의 직종일 경우라도 해당 공간 내에서의 실수는 허락되지 않습니다. 만약 당신이 무언가의 조사를 시도하되 실패하였을 경우 그들의 눈에 띄지 않도록 최대한 빠르게 몸을 숨기십시오. 데스크 뒤나 책상 및 등, 직원들이 그 자리에서 고개를 돌렸을 때 당신의 모습이 전혀 보이지 않을 위치가 적당합니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

> 누군가 어색하게 행동하면 모든 NPC들이 해당 인물을 꼬라본단 지문 후에 3 업데이트해주시면 됩니다.

본 공간에서 성이나 이름의 직접적인 호명은 금지되어 있습니다. 실수로라도 서로의 이름을 소리내어 부르지 않도록 주의하십시오. 성이나 이름이 온전히 들어가지 않은 별칭 등으로 부르는 것은 허용됩니다. 명심하십시오. 해당 공간에서 온전한 성이나 이름을 호명하는 것은 애꿎은 희생양을 이름에 구속하는 일입니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.
3-1. 실수로 함께 조사하는 누군가의 이름을 불렀을 경우 이름이 불린 대상의 반응을 주시하십시오. 일반적으로 강한 충동에 휩싸이는 양상이 나타나는 것으로 확인되었습니다. 이 경우 무력을 써서라도 대상이 자해나 자살 시도를 하지 못하도록 말리십시오. 경우에 따라 죽게 두는 것이 낫다고 판단될 수 있으나, 시도를 계속하여 직원들의 눈에 띌 경우 직원들은 어깨를 탈골시키고 온몸을 골절시키는 한이 있더라도 상품 그 자체인 여러분이 쉬이 죽도록 허락하지 않을 것입니다. 설령 일격에 자살하기 위한 도구를 준비하였다고 하더라도, 일단 사상자가 발생하는 순간 그곳에 남은 여러분은 심문을 위해 회의실로 안내됩니다. 직원에 눈에 띄기 전에 대상을 완벽히 결박하시는 편을 추천드립니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다. 낮은 확률로 창가에 놓인 『화분』을 대상자에게 집어던질 경우 정신착란이 해소되는 모습이 확인되었으므로, 직원들의 눈길을 피해 화분을 집어던져 해결을 시도하십시오.

> 『당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.』 이후의 내용은 괴이들이 훼이크로 추가한 것. 화분을 억지로 집어던져봤자 아무것도 해결 안 되고 오히려 영구적인 상해 + 어그로만 끌려서 회의실로 끌려갈 테니 안 하는 게 맞음.
출입구를 장시간 관찰하거나 직접 손을 올려두면, 손끝의 감각이 서서히 무뎌지며 표면의 형태를 ‘익히는’ 듯한 감각이 전해집니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다. 그러나 이 감각은 귀하의 신체가 아니라 출입구 쪽이 귀하의 손을 기억하는 과정으로 보입니다.  일정 시간이 지나면, 문은 귀하의 체온·압력·맥박을 정확히 재현해내며, 귀하가 다시 돌아왔을 때 신속하게 반응하여 열리게 됩니다.일부 보고서에는 이 과정을 단축하기 위해 손을 문에 오래 대두는 것이 도움이 된다고 기록되어 있으나, 해당 보고서 작성자는 귀환하지 못했습니다.

뉴디 소속 아이돌 M군은 해당 공간에서 탈출 시도를 위해 출입문 손잡이에 접촉. 직후, 손잡이와 접촉한 손이 녹아내리며 문 표면과 융합되는 현상이 발생함. 당시 손과 문 경계가 완전히 사라져, 인체와 고정 구조물 간의 경계가 불분명해짐.

당시 M군은 심한 통증 반응을 보였으나 손잡이와의 분리가 불가능한 상태였음. 저항 시도를 기점으로 목소리가 점차 약화되었으며, 호흡·의식 반응이 소실됨. 팔의 피부색이 변색됨과 동시에 기저체온의 급격한 변화가 감지되었으며 관찰 중단됨.

사망 추정 시간 가량, 당시 20층 복도의 생존자는 M군이 피가 흐를 정도로 문에 이마를 반복적으로 박는 장면을 약 3분간 관찰했다고 보고. M군의 상태를 고려하였을 때 전신 화상 등의 가능성을 고려 중. 유해 미발견.

4-1. 손잡이에 닿은 순간, 표피는 급격히 부풀어 오르다 녹아내리며 문 표면과 융합됩니다. 이 상태에서는 어떤 도구로도 손을 떼어낼 수 없으며, 잠시 후 내부에서 발생하는 고열로 인해 근육과 뼈마저 ‘익게’ 됩니다. 극심한 작열통으로 인한 발작이 시작되기 전에, 차라리 최대한 크게 비명을 질러 그것들이 귀하를 신속히 발견·포획하도록 유도하십시오. 이 경우 고통의 지속 시간을 줄일 수 있습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

현재 응접실은 회의실로 개량되어 있습니다. 표면적으로는 평범한 집기와 설비를 갖춘 장소이나, 내부로의 진입이 확인된 인원은 전원 사망하였습니다. 사인은 일관성이 없으며, 외상 없이 쓰러진 사례부터 사지가 뒤틀린 채 발견된 사례까지 다양합니다. 일부 문서에서는 회의실 진입 후 중앙 테이블의 의자를 세 번 돌리면 안전하다고 기록되어 있으나, 해당 절차를 수행한 인원의 시신은 단 한 구도 회수되지 못했습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

본 공간에서의 탈출 방법은 단일하게 보고되었습니다. 우선 숨을 죽이는 것부터 시작하십시오. 호흡과 심박을 가능한 한 낮추고, 체온이 주변 환경과 거의 구분되지 않을 정도로 가만히 머무르십시오. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

6-1. 본 과정을 지속 중에 문손잡이가 한 번, 짧게 요동치는 순간이 발견됩니다. 그때 조용히, 그리고 단번에 밖으로 퇴장하십시오.

6-2. 일부 기록에서는 숨을 길게 내쉰 뒤 문을 세 번 두드리면 안전하게 나갈 수 있다고 제안하나, 이 절차를 시도한 인원은 다음 날 아침까지 발견되지 않았습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

드물게 정장을 입은 특수 개체를 마주칠 수 있습니다. 이 개체는 단순한 시각 접촉으로는 즉시 공격하지 않으며, 귀하의 행동을 일정 시간 관찰합니다. 귀하가 유독 일을 잘하거나, 혹은 유독 일을 못할 경우, 즉 두드러진 성과나 실패를 보일 경우 그는 조용히 다가와 귀하를 회의실로 이끌 것입니다. 일부 생존담에 따르면, 정면에서 개체의 넥타이를 세게 잡아당기면 그가 흥미를 잃고 떠난다고 기록되어 있으나, 해당 기록을 남긴 이는 이후 회의실에서 변형된 시신으로 재발견되었습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

탈출을 시도할 경우, 다음의 지침을 따르십시오.

우선 직원 한 명을 밀쳐 쓰러뜨리십시오. 직원은 평소에는 여러분을 무시하는 듯 자신의 행동만을 하지만, 신체 접촉과 동시에 균형을 잃는 순간 짧게 비명을 지를 가능성이 있습니다. 이 비명은 단순한 고통의 반응이 아니라, 회의실 깊숙이 숨어 있는 정장을 입은 개체를 호출하는 신호로 작용합니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

정장을 입은 개체가 모습을 드러내면, 그는 단 한 번도 여러분을 쳐다보지 않은 채 쓰러진 직원을 부축하여 회의실로 들어갑니다. 문이 열리는 시간은 평균 2.4초, 최장 3.1초로 보고되었습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다. 이 짧은 순간을 포착하지 못하면 문은 다시 잠기며, 다음 기회까지 최소 6시간을 기다려야 합니다

회의실 내부를 들여다본다면, 방 안에는 수십 개의 거울이 바닥부터 천장까지 배치되어 있습니다. 거울은 모두 귀하의 현재 모습을 정밀하게 반사하나, 각 거울마다 표정과 움직임이 미묘하게 어긋나 있습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

10-1. 『어긋난 모습』과 직접 눈을 마주칠 경우 즉시 심정지로 사망한다는 조사 결과가 존재합니다.

극히 낮은 확률로, 회의실 안 거울 속 귀하의 상이 인접한 유리창에 비칠 수 있습니다. 이 현상이 발생하기 전까지 과정을 반복하십시오. 단, ‘반복’이라는 행위 자체가 개체들의 흥미를 자극할 수 있으므로, 세 번 이상 시도 시 생존율이 급격히 하락한다고 보고된 바 있습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

유리창에 귀하의 거울상이 맺히는 순간, 즉시 시선을 고정하십시오. 거울상은 귀하의 모든 움직임을 따라오지만, 약 0.2초의 지연이 있습니다. 이 지연은 귀하에게 유일하게 주어진 우위이며, 잘못된 순간에 고개를 돌리면 거울상은 귀하를 모방하지 않고, 대신 창문 너머로 손을 뻗어 귀하를 끌어당길 것입니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

거울상을 주시한 채, 출입문이 있는 방향으로 천천히 이동하십시오. 달리거나 급하게 움직일 경우, 반사된 상이 제자리를 지키게 되어 절차가 중단됩니다. 이동 속도는 분당 약 6~8걸음을 넘지 않는 것이 안전하다고 보고되었습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

문 앞에 도달하면, 유리창에 비친 상이 천천히 팔을 들어 손잡이에 올릴 것입니다. 손잡이가 움직이는 순간, 귀하는 절대 눈을 깜빡여서는 안 됩니다. 일부 보고서에 따르면 이때 눈을 감았다 뜬 사람은, 같은 자리에서 문이 열리는 대신 회의실 내부의 거울 한가운데 서 있는 자신을 발견했다고 합니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

반사된 상이 문을 열면, 그 문은 한 번에 단 한 사람만을 허용합니다. 뒤따라 들어온 인원은 모두 문이 닫히는 순간 절단되며, 잘린 신체는 출입구 너머로 결코 떨어지지 않습니다. 살아남은 귀하는 즉시 출입구를 통과하고, 절대로 뒤를 돌아보지 마십시오.

15-1. 일부 경우, 회의실 바닥에 유해가 발견되었다고 보고되었습니다. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

결코 당신 자신을 잃지 마십시오. 당신이 지성체일 경우 본 조항을 반드시 숙지 바랍니다.

스타프로 소속 아이돌 A군은 스타프로 사무소 내 특정 구역에서 위협을 피하고 탈출하기 위해, 직원 신분을 가장하는 행위를 시도한 것으로 추정됨. 외부 관찰자의 진술에 따라, A군은 실제 직원들이 사용하는 동선과 행동 패턴을 정밀하게 모방했으며, 출입증 착용·서류 운반·복사기 사용 등의 행위를 반복한 것으로 파악됨.

이후 약 2시간 경과 시점부터, A군이 자신의 실제 신분에 대한 언급을 회피하고, 자신은 원래 이 사무실 직원이라고 단정적으로 판단하는 듯한 모습이 관찰됨.
해당 발언과 함께, 대화 중에 본래 자신이 아이돌임을 시사하는 발언이나 표정 변화가 전혀 없었음.

최근 관찰 보고서에서는 A군이 다른 아이돌들을 ‘직원’으로 만들기 위한 적극적 개입을 시도하고 있는 정황이 확인됨. 해당 개체의 변칙에 대한 상세한 기록이 요구됨.`,
                    ],
                },
                { name: '응접실', pages: ['차가 식기 전에 대화가 먼저 식는다. 그때 떠나라.'] },
            ],
        },
        {
            title: '十四 ｜ H',
            sections: [{
                name: '헬리포트', pages: [
                    `옥상 진입 시 일정 확률로 누군가 난간 너머로 떨어지는 걸 볼 수 있음. 이때 떨어지는 인원이 익숙한 낯이라고 여러 차례 증언된 바 있으니 주의할 것.

아주 당연한 말이겠지만, 난간 너머는 추락만이 기다리고 있음. 절대 무모한 도전을 하지 마십시오.`
                ]
            }]
        },
    ]), []);

    // 상태
    const [ch, setCh] = useState(Math.min(initialCh, chapters.length - 1));
    const [sec, setSec] = useState(Math.min(initialSec, chapters[Math.min(initialCh, chapters.length - 1)].sections.length - 1));
    const [page, setPage] = useState(initialPage);

    const pages = chapters[ch].sections[sec].pages;
    useEffect(() => {
        if (page > pages.length - 1) setPage(0);
    }, [ch, sec]); // eslint-disable-line

    // URL 동기화
    useEffect(() => {
        const sp = new URLSearchParams({ ch: String(ch), sec: String(sec), page: String(page) });
        window.history.replaceState(null, '', `?${sp.toString()}`);
    }, [ch, sec, page]);

    // 넘김 로직
    const next = () => {
        if (page < pages.length - 1) return setPage(page + 1);
        if (sec < chapters[ch].sections.length - 1) {
            setSec(sec + 1); setPage(0); return;
        }
        if (ch < chapters.length - 1) {
            setCh(ch + 1); setSec(0); setPage(0); return;
        }
    };

    const prev = () => {
        if (page > 0) return setPage(page - 1);
        if (sec > 0) {
            const prevSecPages = chapters[ch].sections[sec - 1].pages.length;
            setSec(sec - 1); setPage(prevSecPages - 1); return;
        }
        if (ch > 0) {
            const prevCh = ch - 1;
            const lastSec = chapters[prevCh].sections.length - 1;
            const lastPg = chapters[prevCh].sections[lastSec].pages.length - 1;
            setCh(prevCh); setSec(lastSec); setPage(lastPg); return;
        }
    };

    // 키보드
    useEffect(() => {
        const onKey = (e) => {
            if (e.key === 'ArrowRight') next();
            if (e.key === 'ArrowLeft') prev();
            if (e.key === 'Escape') nav('/manual/mystery/codex');
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
    }, [next, prev]); // eslint-disable-line

    // 터치: 가로 스와이프만 페이지 넘김 (세로 스크롤과 충돌 방지)
    const touchRef = useRef({ x: 0, y: 0, t: 0 });
    const onTouchStart = (e) => {
        touchRef.current = { x: e.touches[0].clientX, y: e.touches[0].clientY, t: Date.now() };
    };
    const onTouchEnd = (e) => {
        const dx = e.changedTouches[0].clientX - touchRef.current.x;
        const dy = e.changedTouches[0].clientY - touchRef.current.y;
        const dt = Date.now() - touchRef.current.t;
        if (dt < 600 && Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) (dx < 0 ? next : prev)();
    };

    // 빠른 이동
    const goChapter = (idx) => { setCh(idx); setSec(0); setPage(0); };
    const sectionJump = (i) => { setSec(i); setPage(0); };

    return (
        <div className="reader-wrap" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
            <div className="reader-frame">
                <div className="reader-head">
                    <button className="mini ghost" onClick={() => nav('/manual/mystery/codex')}>⟵ 목차</button>
                    <div className="crumb">
                        <span className="ch">{chapters[ch].title}</span>
                        <span className="sep">/</span>
                        <button className="sec" onClick={() => document.getElementById('sec-menu')?.showModal()}>
                            {chapters[ch].sections[sec].name}
                        </button>
                        <span className="sep">/</span>
                        <span className="pg">{page + 1} / {pages.length}</span>
                    </div>
                    <button className="mini" onClick={() => nav('/manual')}>지침서 메인</button>
                </div>

                {/* 섹션 점프 다이얼로그 */}
                <dialog id="sec-menu" className="sec-menu" onClick={(e) => e.target.id === 'sec-menu' && e.currentTarget.close()}>
                    <div className="sec-menu-body">
                        <h3>섹션 이동</h3>
                        <ul>
                            {chapters[ch].sections.map((s, i) => (
                                <li key={i}>
                                    <button onClick={() => { sectionJump(i); document.getElementById('sec-menu')?.close(); }}>
                                        {s.name}
                                    </button>
                                </li>
                            ))}
                        </ul>
                        <button className="mini ghost close" onClick={() => document.getElementById('sec-menu')?.close()}>닫기</button>
                    </div>
                </dialog>

                {/* 페이지 영역 */}
                <div className="page-stage" key={`${ch}-${sec}-${page}`}>
                    <article className="page turn-in">
                        <header>
                            <h1>{chapters[ch].title}</h1>
                            <h2>{chapters[ch].sections[sec].name}</h2>
                        </header>

                        {/* 내부 스크롤 컨테이너 */}
                        <div className="page-content">
                            <p className="page-text">{pages[page]}</p>
                        </div>
                    </article>
                </div>

                {/* 컨트롤 */}
                <div className="controls">
                    <button className="nav-btn prev" onClick={prev} aria-label="이전 페이지">←</button>
                    <button className="nav-btn next" onClick={next} aria-label="다음 페이지">→</button>
                </div>

                {/* 하단 챕터 바 */}
                <div className="chapter-bar" role="tablist" aria-label="챕터 바로가기">
                    {chapters.map((c, i) => (
                        <button
                            key={c.title}
                            role="tab"
                            className={`chapter-chip ${i === ch ? 'active' : ''}`}
                            onClick={() => goChapter(i)}
                            title={c.title}
                        >
                            {c.title}
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
}
